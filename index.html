<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>WAVED (Prototype)</title>
<link rel="shortcut icon" href="/favicon.ico" />
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
<script src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<link rel="stylesheet" type="text/css" href="style/style.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
    
<script type="text/javascript" src="js/components/constants.js"></script>
<script type="text/javascript" src="js/components/us_map.js"></script>


<script type="text/javascript">

    $(document).ready(function() {
        $("#map-colorize-button").attr("disabled", "disabled");
        $("#map-bind-data-button").attr("disabled", "disabled");
        $("#map-render-markers-button").attr("disabled", "disabled");
        $("#map-analytics-button").attr("disabled", "disabled");
        $("#map-highlight-checkbox").attr("disabled", "disabled");
		$("#map-filter-button").attr("disabled", "disabled");
        $("#state-zoom-checkbox").attr("disabled", "disabled");
        $("#map-tooltip-checkbox").attr("disabled", "disabled");
        $("#remove-filter-button").attr("disabled", "disabled");        

        loadDataFilenames();
    });

	function enableMapUIButtons() {
		$("#map-generate-button").attr("disabled", "disabled");
		$("#map-colorize-button").removeAttr("disabled");
		$("#map-bind-data-button").removeAttr("disabled");
		$("#map-render-markers-button").removeAttr("disabled");
		$("#map-analytics-button").removeAttr("disabled");
		$("#map-highlight-checkbox").removeAttr("disabled");
		$("#state-zoom-checkbox").removeAttr("disabled");
		$("#map-tooltip-checkbox").removeAttr("disabled");
		$("#map-filter-button").removeAttr("disabled");
		$("#remove-filter-button").removeAttr("disabled");
	}

    var widgets = [];
</script>
</head>
<body id="main-body">
	<div id="header-container">
		<a href="http://kshsk.github.io/WAVED/" target="_blank"><img
			id="header-logo" src="images/WAVED.png" ondragstart="return false;" /></a>
	</div>
	<div id="main-container">
		<div id="widget-panel">
			<div class="widget-header">Save/Load</div>
			<input type="text" id="application-name"
				placeholder="Application Name" /> <br/>
			<button onclick="save_state()">Save State</button>
			<button onclick="load_state()">Load State</button>
			<br />
			<br />
			<input type="text" id="export-file-name" placeholder="Filename" /> <a
				id="export-file-link" href="" style="display: none"></a>
			<button id="export-demo-button">Export</button>	
				
			<div class="widget-header">Data</div>
			<form action="php/upload_data_file.php" method="post"
				id="dataFileUploadForm" enctype="multipart/form-data">
				<label for="file" class="dataFileLabel">Upload File:</label> <input
					type="file" name="file" id="dataFileUpload"><br>
			</form>
			<button id="submitDataFileUpload">Upload Data</button>	
				
			<div class="widget-header">Map Widget Controls</div>
			<button id="map-generate-button" onclick="us_map.render(); enableMapUIButtons();">Add
				Map Widget</button>
			<br />
			<select id="color-sources">
				<option value="">Select color...</option>
				<option value="red">red</option>
				<option value="blue">blue</option>
				<option value="black">black</option>
				<option value="green">green</option>
				<option value="random">multicolor</option>
			</select>
			<button id="map-colorize-button" onclick="color_map();">Colorize
				Map</button>
			
			<br /><br />
			<select id="data-sources">
				<option value="">Select data to bind...</option>
			</select>
			<button id="map-bind-data-button"
				onclick="bind_csv(); setTimeout(refresh_data_selector, 250);">Bind
				data</button>
			
			<br />
			<select id="analytics-select">
				<option value="">Enter Google Analytics UA</option>
				<option value="UA-45743706-1">UA-45743706-1</option>
			</select>
			<button id="map-analytics-button" onclick="add_analytics();">Add</button>
			
			<br />
			<span class="checkboxLabel">Highlighting: </span>
			<input
				type="checkbox" id="map-highlight-checkbox"
				onclick="toggle_map_highlight();" />
				
			<br />
			<span class="checkboxLabel">State Tooltip on Hover: </span>
			<input
				type="checkbox" id="map-tooltip-checkbox"
				onclick="toggle_map_tooltip();" />
				
			<br />
            <span class="checkboxLabel">State zoom: </span>
            <input
                type="checkbox" id="state-zoom-checkbox"
                onclick="toggle_state_zoom();" />
                
            <br />  
			<button id="map-render-markers-button"
					onclick="show_glyph_dialog();">Add/Edit city markers</button>
			<br>
			
			<button id="map-filter-button"
					onclick="show_filter_dialog();">Add/Edit Filter</button>
			<button id="remove-filter-button"
					onclick="remove_filter();">Remove Filter</button>
					
			<br>

			<div id="widget-selector-container">
				<div class="widget-header">Widgets</div>
				<select id="widget-selector" size="5"></select>
			</div>
			<div id="data-selector-container">
				<div class="widget-header">Data</div>
				<select id="data-selector" size="5"></select>
			</div>

			<div class="widget-header">Debug</div>
			<button onclick="log_svg()">Log SVG</button>
			<button onclick="log_state()">Log State</button>
			<br />
		</div>
		
		<div id="workspace-panel">
			<div id="workspace-header">Map Panel</div>
			<div id="workspace-preview"></div>
			<div id="tooltip" class="hidden">
				<p><span id="state-name"></span></p>
			</div>		
		</div>
		
		<div id="glyph-creation-dialog" class="hidden">
			<table>
				<tr>
					<td>Data:</td>
					<td>
						<select id="glyph-data">
						</select>
					</td>
				</tr>
				<tr>
					<td>Color</td>
					<td>
						<select id="glyph-color">
							<option value="red">red</option>
							<option value="blue">blue</option>
							<option value="black">black</option>
							<option value="green">green</option>
							<option value="yellow">yellow</option>
							<option value="white">white</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>Opacity</td>
					<td>
						<select id="glyph-opacity">
							<option value="1.0">1.0</option>
							<option value="0.75">0.75</option>
							<option value="0.5">0.5</option>
							<option value="0.25">0.25</option>
							<option value="0.1">0.1</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>Scale Size by </td>
					<td>
						<select id="glyph-size">
						</select>
					</td>
				</tr>
				<tr>
					<td>Latitude</td>
					<td>
						<select id="glyph-lat">
						</select>
					</td>
				</tr>
				<tr>
					<td>Longitude</td>
					<td>
						<select id="glyph-lon">
						</select>
					</td>
				</tr>
			</table>
		</div>
		
		<div id="glyph-filter-dialog" class="hidden">
			<table>
				<tr>
					<td>Data:</td>
					<td><select id="filter-data"></select></td>
				</tr>
				<tr>
					<td>Field:</td>
					<td><select id="filter-field"></select></td>
				</tr>
				<tr>
					<td>Operator:</td>
					<td><select id="filter-operator">
						<option value="<"><</option>
						<option value="<="><=</option>
						<option value="=">=</option>
						<option value=">=">>=</option>
						<option value=">">></option>
						<option value="!=">!=</option>
					</select></td>
				</tr>
				<tr>
					<td>Value:</td>
					<td><input type="text" id="filter-value" /></td>
				</tr>
			</table>
		</div>
		
		<div id="remove-filter-dialog" class="hidden">
			Data: <select id="remove-filter-data"></select>
		</div>
	</div>
	<script>
        var state = {};

        $(document).ready(function() {
            $.extend(state, {
                "widgets" : {}
            });
        });

        function color_map() {
            var value = $("#color-sources").val();

            if (value) {
                us_map.colorize(value);
            }
            else {
                alert("Pick a color from the list.");
            }
        }

        function log_svg() {
            console.log(us_map.get_svg());
            console.dir("Bound data: " + us_map.data.length);
            console.dir(state);
        }

        function log_state() {
            console.log(state);
        }

        function bind_csv() {
            var value = $("#data-sources").val()
            if (value !== "") {
                us_map.bind_data(value);
                alert("Data bound!");
            }
            else {
                alert("No data selected");
            }
        }

        function add_analytics() {
            var UA = $("#analytics-select").val();

            if (UA !== "") {
                us_map.add_analytics(UA);
                alert("Analytics Added!");
            }
            else {
                alert("No UA selected");
            }
        }

        function load_state() {

            // Get application name from text box
            var applicationName = $('#application-name').val();

            // Require a name to continue
            if (applicationName.length <= 0) {
                alert("Loading application state requires an application name!");
            }
            // Load state from the database
            else {
                var request = {
                    'application' : applicationName
                };
                $.getJSON('php/getApplicationState.php', request, set_state);
            }
        }

        function set_state(saved_state) {
            console.log(saved_state);
            // Clear the iFrame, widgets, widget selector, and update
            // data list
            $("#" + constants.MAP_PREVIEW_ID).empty();
            $("#widget-selector").empty();
            widgets.length = 0;
            
            setTimeout(refresh_data_selector, 250);

			if (typeof saved_state.widgets.us_map !== 'undefined') {
				us_map.load_state(saved_state.widgets.us_map);
				
				enableMapUIButtons();
			}
			
			if (typeof saved_state.widgets.us_map.UA !== 'undefined') {
				$("#map-analytics-button").attr("disabled", "disabled");
				$("#analytics-select").val("UA-45743706-1");
			}
			
			if (saved_state.widgets.us_map.highlightingEnabled) {
				$('#map-highlight-checkbox').prop('checked', true);
			}
			
			if (saved_state.widgets.us_map.tooltip) {
				$('#map-tooltip-checkbox').prop('checked', true);
			}
			
			if (saved_state.widgets.us_map.stateZoomEnabled){
			    $('#state-zoom-checkbox').prop('checked', true);
			}
			
			if (typeof saved_state.widgets.us_map.color !== 'undefined') {
				$("#color-sources").val(saved_state.widgets.us_map.color);
			} else {
				$("#color-sources").val("black");
			}
        }

        function save_state() {
            // Get application name from text box
            var applicationName = $('#application-name').val();

            // Require a name to continue
            if (applicationName.length <= 0) {
                alert("Saving application state requires an application name!");
            }
            // Load state from the database
            else {
                var request = {
                    'application' : applicationName,
                    'json' : JSON.stringify(state)
                };
                $.post('php/setApplicationState.php', request);
            }
        }

        $("#widget-panel").on("click", "#submitDataFileUpload", function(event) {
            var form = new FormData();
            var file = $("#dataFileUpload")[0].files[0];
            if (file === undefined) {
                alert("Cannot upload blank file.");
                return;
            }

            form.append("file", file);

            $.ajax({
                type : "POST",
                url : "php/upload_data_file.php",
                data : form,
                processData : false,
                contentType : false,
                success : function(data) {
                    var dataObj = JSON.parse(data);
                    if (!dataObj.success) {
                        alert(dataObj.errorMessage);
                        return;
                    }

                    var dataSelect = $("#data-sources");
                    var newFileOption = $("<option/>").val(dataObj.filePath).text(dataObj.filePath);
                    dataSelect.append(newFileOption);
                    alert("Uploaded new file");
                }

            });
        });

        $("#widget-panel").on("click", "#export-demo-button", function() {
            export_app();
        });

        function export_app() {
            // Change this to use the app name once that is defined.
            var appName = $("#export-file-name").val();
            if (appName === undefined || appName === "") {
                alert("Need an app name");
                return;
            }

            var html = getGeneratedHtml();
            var dataFiles = getDataFiles();
            generateZipfile(appName, dataFiles, html);
        }

        function getGeneratedHtml() {
            var widgetJS = "";
            for (var i = 0; i < widgets.length; i++) {
                widgetJS += widgets[i].exportJS();
            }

            var html = "<html>" + "\n" 
                    + "<head>" + "\n" + constants.D3_IMPORT + "\n" + constants.JQUERY_IMPORT + "\n"
                    + constants.JQUERY_UI_IMPORT + "\n" + constants.JQUERY_UI_STYLE_IMPORT + "\n" + constants.D3_TOPOJSON_IMPORT + "\n"
                    + "<style type=\"text/css\">" + "\n" 
                    + "#tooltip {" + "\n" 
					+ "\t" + "position: absolute;" + "\n" 
					+ "\t" + "width: 120px;" + "\n" 
					+ "\t" + "height: auto;" + "\n" 
					+ "\t" + "padding: 10px;" + "\n" 
					+ "\t" + "background-color: white;" + "\n" 
					+ "\t" + "-webkit-border-radius: 10px;" + "\n" 
					+ "\t" + "-moz-border-radius: 10px;" + "\n" 
					+ "\t" + "border-radius: 10px;" + "\n" 
					+ "\t" + "-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);" + "\n" 
					+ "\t" + "-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);" + "\n" 
					+ "\t" + "box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);" + "\n" 
					+ "\t" + "pointer-events: none;" + "\n" 
					+ "\t" + "}" + "\n\n" 

					+ "#tooltip.hidden {" + "\n" 
					+ "\t" + "display: none;" + "\n" 
					+ "}" + "\n\n" 

					+ "#tooltip p {" + "\n" 
					+ "\t" + "margin: 0;" + "\n" 
					+ "\t" + "font-family: sans-serif;" + "\n" 
					+ "\t" + "font-size: 16px;" + "\n" 
					+ "\t" + "line-height: 20px;" + "\n" 
					+ "}" + "\n" 
                    + "</style>" + "\n"
                    + "<script type=\"text/javascript\">" + "\n" + us_map.get_GA_header_script() + "<\/script>" + "\n"
                    + "</head>" + "\n"
                    + "<body id=\"" + constants.EXPORT_CONTAINER_ID + "\">" + "\n"
                    + "<script type=\"text/javascript\">" + "\n" + widgetJS + "<\/script>" + "\n"
                    + "<div id=\"tooltip\" class=\"hidden\"><p><span id=\"state-name\"></span></p></div>" + "\n"
                    + "</body>" + "\n"
                    + "</html>";

            return html;
        }

        function getDataFiles() {
            var filenames = {};
            for (var i = 0; i < widgets.length; i++) {
                var widget = widgets[i];
                for (var j = 0; j < widget.data.length; j++) {
                    filenames[widget.data[j].filepath] = true;
                }
            }

            // TODO: Don't hardcode this last filename. It should be included in the widget somewhere.
            filenames['data/states.json'] = true;
            return Object.keys(filenames);
        }

        function generateZipfile(appName, dataFiles, html) {
            $.ajax({
                type : "POST",
                url : "php/create_zip.php",
                data : {
                    demo : appName,
                    data_files : dataFiles,
                    html : html
                },
                success : function(data) {
                    downloadGeneratedZipfile(data, appName + ".zip");
                }
            });
        }

        function downloadGeneratedZipfile(data, fileName) {
            if (data !== "success") {
                alert("Could not download zip file.");
                return;
            }

            var exportLink = $("#export-file-link");

            // Set and click a hidden link, so that this doesn't require another step by the user.
            exportLink.attr("href", "php/download_zip.php?fileName=" + fileName);
            exportLink.attr("download", fileName);
            exportLink[0].click();
        }

        function loadDataFilenames() {
            var dataFileSelect = $("#data-sources");

            $.ajax({
                type : "GET",
                url : "php/getDataFilePaths.php",
                success : function(data) {
                    var filenames = JSON.parse(data);
                    for (var i = 0; i < filenames.length; i++) {
                        var name = filenames[i];
                        var option = $("<option/>").val(name).text(name).appendTo(dataFileSelect);
                    }
                }
            });
        }

        function refresh_data_selector() {
            // TODO: Make this grab the currently selected widget from widget-selector
            // and populate the data-selector with the file names of its bound data.            
            $("#data-selector").empty();
            for (var i = 0; i < us_map.data.length; i++) {
                $("#data-selector").append("<option>" + us_map.data[i].filepath + "</option>");
            }
        }

        function toggle_map_highlight() {
            us_map.set_highlighting($("#map-highlight-checkbox").is(':checked'));
        }
        
        function toggle_map_tooltip() {
        	us_map.set_tooltip($("#map-tooltip-checkbox").is(':checked'));
        }
        
        function toggle_state_zoom(){
            us_map.set_state_zoom($("#state-zoom-checkbox").is(':checked'));
        }
        
        function show_glyph_dialog() {
        
            $("#glyph-data").empty();
            $("#glyph-lat").empty();
            $("#glyph-lon").empty();
            $("#glyph-size").empty();
            
            $("#glyph-lat").append("<option value=\"\">Select a data field.</option>");
            $("#glyph-lon").append("<option value=\"\">Select a data field.</option>");
            $("#glyph-size").append("<option value=\"\">Select a data field.</option>");
            
            for (var i = 0; i < us_map.data.length; i++) {
                $("#glyph-data").append("<option value=\"" + i + "\">" + us_map.data[i].filepath + "</option>");
                var keys = Object.keys(us_map.data[i].data[0]);
                
                for (var j = 0; j < keys.length; j++) {
                    $("#glyph-lat").append("<option value=\"" + keys[j] + "\">" + us_map.data[i].filepath + " - " + keys[j] + "</option>");
                    $("#glyph-lon").append("<option value=\"" + keys[j] + "\">" + us_map.data[i].filepath + " - " + keys[j] + "</option>");
                    $("#glyph-size").append("<option value=\"" + keys[j] + "\">" + us_map.data[i].filepath + " - " + keys[j] + "</option>");
                }
            }
        
            $("#glyph-creation-dialog").dialog({
                dialogClass: "no-close",
                  title: "Add Glyphs",
                  modal: true,
                show: true,
                hide: "fade",
                width: "400px",
                buttons: [
                    {
                        text: "Add",
                        click: function() {
                            
                            var options = {
                                data: us_map.data[parseInt($("#glyph-data").val())],
                                color: $("#glyph-color").val(),
                                lat: $("#glyph-lat").val(),
                                lon: $("#glyph-lon").val(),
                                size: $("#glyph-size").val(),
                                opacity: parseFloat($("#glyph-opacity").val())
                            };
                            
                            if (options.lat.length && options.lon.length && options.size.length) {
                                us_map.circle_element.render(options);
                                $(this).dialog("close");
                            } else {
                                alert("Data, Lat, Lon, and Size need to bee selected.");
                            }
                        } 
                    },
                    {
                        text: "Cancel",
                        click: function() {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        }
        
        function show_filter_dialog() {
        	
        	// TODO: Listen to the select/onchange event of filter-data and then 
        	// update filter-field with only the fields from the selected data file.
        	
        	$("#filter-data").empty();
        	$("#filter-field").empty();
        	$("#filter-field").append("<option value=\"\">Select a data field.</option>");
        
        	for (var i = 0; i < us_map.data.length; i++) {
        		$("#filter-data").append("<option value=\"" + i + "\">" + us_map.data[i].filepath + "</option>");
        		var keys = Object.keys(us_map.data[i].data[0]);
        		
        		for (var j = 0; j < keys.length; j++) {
        			$("#filter-field").append("<option value=\"" + keys[j] + "\">" + us_map.data[i].filepath + " - " + keys[j] + "</option>");
				}
        	}
        
			$("#glyph-filter-dialog").dialog({
				dialogClass: "no-close",
			  	title: "Add Filter",
			  	modal: true,
				show: true,
				hide: "fade",
				width: "400px",
				buttons: [
					{
						text: "Add",
						click: function() {
						
							var value = $("#filter-value").val();
							var field = $("#filter-field").val();
							var operator = $("#filter-operator").val();
							
							if (value.length && field.length) {
								var glyphOptions = {
									data: us_map.data[parseInt($("#filter-data").val())],
									color: us_map.circle_element.color,
            						opacity: us_map.circle_element.opacity,
						            size: us_map.circle_element.size,
									lat: us_map.circle_element.lat,
						            lon: us_map.circle_element.lon
								};
								
								var filterOptions = {
									data: parseInt($("#filter-data").val()),
									value: value,
									field: field,
									operator: operator
								};
								
								us_map.circle_element.render(glyphOptions, filterOptions);
								$("#remove-filter-button").removeAttr("disabled");
								$(this).dialog("close");
							} else {
								alert("Please select a field and enter a value.");
							}
						} 
					},
					{
						text: "Cancel",
						click: function() {
							$(this).dialog("close");
						}
					}
				]
			});
        }
        
        function remove_filter() {
        
        	$("#remove-filter-data").empty();
        	
        	for (var i = 0; i < us_map.data.length; i++) {
        		$("#remove-filter-data").append("<option value=\"" + i + "\">" + us_map.data[i].filepath + "</option>");
        	}
        
        	$("#remove-filter-dialog").dialog({
				dialogClass: "no-close",
			  	title: "Remove Filter",
			  	modal: true,
				show: true,
				hide: "fade",
				width: "400px",
				buttons: [
					{
						text: "Remove",
						click: function() {

							var glyphOptions = {
								data: us_map.data[parseInt($("#remove-filter-data").val())],
								color: us_map.circle_element.color,
								opacity: us_map.circle_element.opacity,
								size: us_map.circle_element.size,
								lat: us_map.circle_element.lat,
								lon: us_map.circle_element.lon
							};
		
							state.widgets.us_map.data_filter = undefined; // Hacky
							us_map.circle_element.render(glyphOptions);
							$("#remove-filter-button").attr("disabled", "disabled");
							$(this).dialog("close");						
						} 
					},
					{
						text: "Cancel",
						click: function() {
							$(this).dialog("close");
						}
					}
				]
			});
        }
    </script>
</body>
</html>
